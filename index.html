<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HMP â€“ Health Medical Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#d32f2f">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 10px;
}

.card {
  background: #fff;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.emergency { border-left: 6px solid #d32f2f; }
.private { display:none; border-left:6px solid #1976d2; }

.section-title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 8px;
}

input, textarea, select {
  width: 100%;
  padding: 8px;
  margin-top: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

button {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  border: none;
  border-radius: 8px;
  background: #1976d2;
  color: #fff;
  font-size: 16px;
}

ul { padding-left: 18px; }
li { margin-bottom: 8px; }

.toggle {
  color: #1976d2;
  font-size: 14px;
  cursor: pointer;
  margin-top: 6px;
}

#pinError { color:red; display:none; }
</style>
</head>

<body>

<!-- ğŸš‘ EMERGENCY MODE -->
<div id="lockNotice" class="card emergency" style="display:none;">
  <div class="section-title">ğŸš‘ Emergency Access</div>
  <p>This profile was opened via NFC / QR for emergency use.</p>
</div>

<!-- ğŸš¨ BASIC INFO -->
<div class="card emergency">
  <div class="section-title">ğŸš¨ Emergency Info</div>
  <p><strong>Name:</strong> Daniel</p>
  <p><strong>DOB:</strong> <span id="dobDisplay">Not set</span></p>
</div>

<!-- ğŸ“ QUICK ACTIONS -->
<div class="card emergency">
  <div class="section-title">ğŸ“ Emergency Actions</div>
  <a href="tel:+14165551234"><button style="background:#d32f2f;">Call Emergency Contact</button></a>
  <a href="tel:+14165559876"><button>Call Doctor</button></a>
  <a href="tel:+14165554321"><button>Call Pharmacy</button></a>
</div>

<!-- âš•ï¸ MEDICAL PROBLEMS -->
<div class="card emergency">
  <div class="section-title">âš•ï¸ Medical Problems</div>
  <ul id="medicalList"></ul>
  <span class="toggle" onclick="editMedical()">âœï¸ Edit</span>
</div>

<div class="card" id="medicalEdit" style="display:none;">
  <textarea id="medicalInput"></textarea>
  <button onclick="saveMedical()">Save</button>
</div>

<!-- ğŸ¥ HOSPITAL -->
<div class="card emergency">
  <div class="section-title">ğŸ¥ Hospital Preference</div>
  <p><strong>Hospital:</strong> <span id="hospitalDisplay">Not set</span></p>
  <p><strong>City:</strong> <span id="cityDisplay">Not set</span></p>
</div>

<!-- ğŸ“· QR -->
<div class="card emergency">
  <div class="section-title">ğŸ“· QR Backup</div>
  <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://hmp-daniel.app"
       style="display:block;margin:auto;">
</div>

<!-- ğŸ” PIN -->
<div class="card">
  <div class="section-title">ğŸ” Private Access</div>
  <input type="password" id="pinInput" placeholder="Enter PIN">
  <button onclick="unlock()">Unlock</button>
  <div id="pinError">Wrong PIN</div>
</div>

<div id="private">

<!-- ğŸ“ NOTES -->
<div class="card private">
  <div class="section-title">ğŸ“ Personal Health Notes</div>
  <p id="notesDisplay"></p>
  <span class="toggle" onclick="editNotes()">âœï¸ Edit</span>
</div>

<div class="card" id="notesEdit" style="display:none;">
  <textarea id="notesInput"></textarea>
  <button onclick="saveNotes()">Save</button>
</div>

<!-- ğŸ’Š MEDICATIONS -->
<div class="card private">
  <div class="section-title">ğŸ’Š Medications</div>
  <ul id="medList"></ul>
  <span class="toggle" onclick="editMeds()">âœï¸ Edit</span>
</div>

<div class="card" id="medEdit" style="display:none;">
  <textarea id="medInput" placeholder="Medication | Dose | Time"></textarea>
  <button onclick="saveMeds()">Save</button>
</div>

<!-- ğŸ”” REMINDER -->
<div class="card private">
  <div class="section-title">ğŸ”” Medication Reminder</div>
  <input type="time" id="reminderTime">
  <input id="reminderText" placeholder="Reminder text">
  <button onclick="createDailyMedicationReminder()">
  Set Daily Medication Reminder
</button>
</div>

<!-- ğŸ§¾ DOCUMENTS -->
<div class="card private">
  <div class="section-title">ğŸ§¾ Doctor & Lab Documents</div>
  <input type="file" id="docFile">
  <input id="docNote" placeholder="Notes">
  <button onclick="saveDoc()">Upload</button>
  <ul id="docList"></ul>
</div>

<!-- ğŸ§¬ LAB VALUES -->
<div class="card private">
  <div class="section-title">ğŸ§¬ Lab Values</div>
  <input id="labTest" placeholder="Test">
  <input id="labValue" placeholder="Value">
  <input id="labUnit" placeholder="Unit">
  <input id="labRange" placeholder="Range">
  <input type="date" id="labDate">
  <button onclick="saveLab()">Add</button>
  <ul id="labList"></ul>
</div>

<!-- ğŸ“Š LAB CHART -->
<div class="card private">
  <div class="section-title">ğŸ“Š Lab Trends</div>
  <select id="trendTest" onchange="drawTrend()">
    <option value="">Select test</option>
    <option>Hemoglobin A1C</option>
    <option>Cholesterol</option>
    <option>LDL</option>
    <option>HDL</option>
  </select>
  <canvas id="trendChart"></canvas>
</div>

<!-- ğŸ§¬ FHIR -->
<div class="card private">
  <div class="section-title">ğŸ§¬ FHIR Export</div>
  <button onclick="exportFHIR()">Export Labs (FHIR)</button>
</div>

<!-- â˜ï¸ BACKUP -->
<div class="card private">
  <div class="section-title">â˜ï¸ Encrypted Backup</div>
  <input type="password" id="backupPwd" placeholder="Backup password">
  <button onclick="exportBackup()">Export Backup</button>
  <input type="file" id="backupFile">
  <button onclick="importBackup()">Restore Backup</button>
</div>

</div>

<script>
const PIN="1932";

/* ---------- CORE ---------- */
function unlock(){
  if(pinInput.value===PIN){
    document.querySelectorAll(".private").forEach(e=>e.style.display="block");
    pinError.style.display="none";
  } else pinError.style.display="block";
  pinInput.value="";
}

function detectEmergency(){
  if(!document.referrer) lockNotice.style.display="block";
}

/* ---------- STORAGE HELPERS ---------- */
function save(key,val){ localStorage.setItem(key,JSON.stringify(val)); }
function load(key){ return JSON.parse(localStorage.getItem(key)||"[]"); }

/* ---------- MEDICAL ---------- */
function editMedical(){ medicalEdit.style.display="block"; medicalInput.value=load("medical").join(", "); }
function saveMedical(){ save("medical",medicalInput.value.split(",").map(v=>v.trim())); medicalEdit.style.display="none"; loadMedical(); }
function loadMedical(){ medicalList.innerHTML=""; load("medical").forEach(m=>medicalList.innerHTML+=`<li>${m}</li>`); }

/* ---------- NOTES ---------- */
function editNotes(){ notesEdit.style.display="block"; notesInput.value=localStorage.getItem("notes")||""; }
function saveNotes(){ localStorage.setItem("notes",notesInput.value); notesEdit.style.display="none"; loadNotes(); }
function loadNotes(){ notesDisplay.innerText=localStorage.getItem("notes")||"None"; }

/* ---------- MEDS ---------- */
function editMeds(){ medEdit.style.display="block"; medInput.value=load("meds").join("\n"); }
function saveMeds(){ save("meds",medInput.value.split("\n")); medEdit.style.display="none"; loadMeds(); }
function loadMeds(){ medList.innerHTML=""; load("meds").forEach(m=>medList.innerHTML+=`<li>${m}</li>`); }

/* â€--------- reminders ------ */
function createDailyMedicationReminder(
  hour = 9,
  minute = 0,
  medication = "Medication"
) {
  const now = new Date();

  const start = new Date();
  start.setHours(hour, minute, 0, 0);

  // If time already passed today, start tomorrow
  if (start <= now) {
    start.setDate(start.getDate() + 1);
  }

  const end = new Date(start);
  end.setMinutes(end.getMinutes() + 10);

  const formatDate = (date) =>
    date.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";

  const ics = `
BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//HMP//Daily Medication Reminder//EN
BEGIN:VEVENT
UID:${Date.now()}@hmp
DTSTAMP:${formatDate(new Date())}
DTSTART:${formatDate(start)}
DTEND:${formatDate(end)}
RRULE:FREQ=DAILY
SUMMARY:ğŸ’Š Take ${medication}
DESCRIPTION:Daily medication reminder from HMP
BEGIN:VALARM
TRIGGER:-PT10M
ACTION:DISPLAY
DESCRIPTION:Medication reminder
END:VALARM
END:VEVENT
END:VCALENDAR
`.trim();

  const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  window.location.href = url;
}
/* ---------- LABS ---------- */
function saveLab(){
  const labs=load("labs");
  labs.push({test:labTest.value,value:labValue.value,unit:labUnit.value,range:labRange.value,date:labDate.value});
  save("labs",labs); loadLabs();
}
function loadLabs(){
  labList.innerHTML="";
  load("labs").forEach((l,i)=>labList.innerHTML+=`<li>${l.test}: ${l.value}${l.unit} (${l.date})</li>`);
}

/* ---------- CHART ---------- */
let chart;
function drawTrend(){
  const test=trendTest.value;
  const data=load("labs").filter(l=>l.test===test);
  const ctx=trendChart.getContext("2d");
  if(chart) chart.destroy();
  chart=new Chart(ctx,{type:"line",data:{labels:data.map(l=>l.date),datasets:[{label:test,data:data.map(l=>l.value)}]}});
}

/* ---------- FHIR ---------- */
function exportFHIR(){
  const labs=load("labs");
  const bundle={resourceType:"Bundle",type:"collection",entry:labs.map((l,i)=>({resource:{resourceType:"Observation",id:i,status:"final",code:{text:l.test},valueQuantity:{value:+l.value,unit:l.unit},effectiveDateTime:l.date}}))};
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([JSON.stringify(bundle,null,2)],{type:"application/json"}));
  a.download="HMP-FHIR.json"; a.click();
}

/* ---------- INIT ---------- */
window.onload=()=>{
  detectEmergency();
  loadMedical(); loadNotes(); loadMeds(); loadLabs(); loadreminders();
};
</script>

</body>
</html>